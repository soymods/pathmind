name: Build

on:
  push:
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: gradle

      - name: Download Baritone API dependency
        run: |
          mkdir -p libs
          curl -L -o libs/baritone-api-fabric-1.15.0.jar \
            https://github.com/cabaletta/baritone/releases/download/v1.15.0/baritone-api-fabric-1.15.0.jar

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Unit tests
        run: ./gradlew test

      - name: Build all supported Minecraft targets
        run: ./gradlew buildAllTargets

      - name: Verify all expected release jars exist
        shell: bash
        run: |
          EXPECTED_COUNT="$(grep -E '^\s*"[0-9]+\.[0-9]+(\.[0-9]+)?"\s+to\s+MinecraftVersionSpec\(' build.gradle.kts | wc -l | tr -d ' ')"
          ACTUAL_COUNT="$(find build/libs -maxdepth 1 -type f -name '*.jar' \
            | grep -Ev '(-sources|-javadoc|-dev|-shadow|-all)\.jar$' \
            | grep -c '\+mc')"

          echo "Expected jars: $EXPECTED_COUNT"
          echo "Actual jars:   $ACTUAL_COUNT"

          if [ "$ACTUAL_COUNT" -ne "$EXPECTED_COUNT" ]; then
            echo "Mismatch between supported targets and built jars."
            ls -la build/libs || true
            exit 1
          fi

      - name: Pick main mod jar
        id: jar
        shell: bash
        run: |
          # Choose the primary jar for the configured Minecraft version.
          MC_VERSION="$(grep -E '^minecraft_version=' gradle.properties | head -n 1 | cut -d= -f2-)"
          JAR="$(ls -1 "build/libs/"*mc"${MC_VERSION}".jar 2>/dev/null \
            | grep -Ev '(-sources|-javadoc|-dev|-shadow|-all)\.jar$' \
            | head -n 1)"

          if [ -z "$JAR" ]; then
            echo "No suitable jar found in build/libs/"
            ls -la build/libs || true
            exit 1
          fi

          BASENAME="$(basename "$JAR" .jar)"
          echo "jar_path=$JAR" >> "$GITHUB_OUTPUT"
          echo "artifact_name=$BASENAME" >> "$GITHUB_OUTPUT"

      - name: Upload mod jar (named like the jar)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.jar.outputs.artifact_name }}
          path: ${{ steps.jar.outputs.jar_path }}
